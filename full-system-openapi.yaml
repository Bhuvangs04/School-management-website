openapi: 3.0.0
info:
  title: School Management Microservices – Full API Specification
  version: 1.0.0
  description: |
    This file contains the complete OpenAPI documentation for all microservices:
      - Auth Service
      - User Service
      - College Service
      - Issue Service
      - Attendance Service
      - Homework Service
      - Notification Service
      - File Storage Service
      - Event Bus Integration (Async events section)
    Includes API Key structure, JWT usage, full request/response bodies, and workflows.


---------------------------------------Ngix config----------------------------------------------------
# -------------------------------------------------
# HTTP → HTTPS REDIRECT
# -------------------------------------------------
server {
    listen 80;
    server_name schoolsuite.site www.schoolsuite.site;
    return 301 https://$host$request_uri;
}

# -------------------------------------------------
# HTTPS API GATEWAY
# -------------------------------------------------
server {
    listen 443 ssl http2;
    server_name schoolsuite.site www.schoolsuite.site;

    ssl_certificate     /etc/letsencrypt/live/schoolsuite.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/schoolsuite.site/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    # ================= AUTH SERVICE (PUBLIC) =================
    location ^~ /auth/login {
        proxy_pass http://127.0.0.1:4000;
    }

    location ^~ /auth/register {
        proxy_pass http://127.0.0.1:4000;
    }

    location ^~ /auth/refresh {
        proxy_pass http://127.0.0.1:4000;
    }

    location ^~ /auth/reset-password {
        proxy_pass http://127.0.0.1:4000;
    }

    # ================= AUTH VERIFY (INTERNAL) =================
    location = /service/verify {
        internal;
        proxy_pass http://127.0.0.1:4000;
        proxy_set_header Authorization $http_authorization;
    }

    # ================= COLLEGE (PUBLIC) =================
    location ^~ /api/college/apply {
        proxy_pass http://127.0.0.1:5002;
    }

    location ^~ /api/college/verify-email {
        proxy_pass http://127.0.0.1:5002;
    }

    location ^~ /api/college/recover {
        proxy_pass http://127.0.0.1:5002;
    }

    location ~ ^/api/college/[^/]+$ {
        proxy_pass http://127.0.0.1:5002;
    }

    location = /health {
        proxy_pass http://127.0.0.1:5002;
    }

    # ================= COLLEGE (PROTECTED) =================
    location /api/college/ {
        auth_request /service/verify;

        auth_request_set $user_id    $upstream_http_x_user_id;
        auth_request_set $user_role  $upstream_http_x_user_role;
        auth_request_set $college_id $upstream_http_x_college_id;

        proxy_set_header X-Trusted-Request true;
        proxy_set_header X-User-Id         $user_id;
        proxy_set_header X-User-Role       $user_role;
        proxy_set_header X-College-Id      $college_id;

        proxy_pass http://127.0.0.1:5002;
    }

    # ================= ADMIN (PROTECTED) =================
    location /api/admin/ {
        auth_request /service/verify;

        auth_request_set $user_id    $upstream_http_x_user_id;
        auth_request_set $user_role  $upstream_http_x_user_role;
        auth_request_set $college_id $upstream_http_x_college_id;

        proxy_set_header X-Trusted-Request true;
        proxy_set_header X-User-Id         $user_id;
        proxy_set_header X-User-Role       $user_role;
        proxy_set_header X-College-Id      $college_id;

        proxy_pass http://127.0.0.1:5002;
    }

    # ================= ACTION (PROTECTED) =================
    location /action/ {
        auth_request /service/verify;

        auth_request_set $user_id   $upstream_http_x_user_id;
        auth_request_set $user_role $upstream_http_x_user_role;

        proxy_set_header X-Trusted-Request true;
        proxy_set_header X-User-Id         $user_id;
        proxy_set_header X-User-Role       $user_role;

        proxy_pass http://127.0.0.1:4000;
    }
}
